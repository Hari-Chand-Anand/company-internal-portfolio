<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Machine â€¢ HCA Internal Portfolio</title>
  <link rel="stylesheet" href="assets/styles.css" />

  <style>
    /* ---------- Font: IKAROS (put file in assets/fonts/) ---------- */
    @font-face{
      font-family:"Ikaros";
      src:url("assets/fonts/ikaros.woff2") format("woff2"),
          url("assets/fonts/ikaros.woff") format("woff");
      font-weight:400;
      font-style:normal;
      font-display:swap;
    }
    :root{
      --ui-font: Ikaros, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

      /* Apple-like glass */
      --glass: rgba(255,255,255,.035);
      --glass-strong: rgba(255,255,255,.055);
      --stroke: rgba(255,255,255,.12);
      --stroke-soft: rgba(255,255,255,.10);
      --shadow: 0 28px 90px rgba(0,0,0,.45);
      --inner: inset 0 1px 0 rgba(255,255,255,.06);
      --blur: blur(16px);
    }

    body{
      font-family: var(--ui-font);
      letter-spacing: 0.01em;
      background: #050712; /* fallback */
      position: relative;
      overflow-x: hidden;
    }
    h1,h2,h3,.section-title,.label,.mv-title{ font-family: var(--ui-font); }

    /* ---------- Subtle NET effect overlay (like other pages) ---------- */
    /* Uses pure CSS so you don't need extra JS. It's subtle + performant. */
    .net-overlay{
      pointer-events:none;
      position: fixed;
      inset: 0;
      z-index: 0;
      opacity: .45;
      mix-blend-mode: screen;
      filter: saturate(1.1);
      background:
        radial-gradient(1200px 700px at 20% 25%, rgba(106,167,255,.22), transparent 62%),
        radial-gradient(1000px 600px at 78% 55%, rgba(106,167,255,.16), transparent 64%),
        radial-gradient(800px 520px at 45% 85%, rgba(106,167,255,.10), transparent 66%);
    }
    .net-overlay::before{
      content:"";
      position:absolute;
      inset:-80px;
      opacity:.18;
      background:
        repeating-linear-gradient(115deg,
          rgba(106,167,255,.18) 0px,
          rgba(106,167,255,.18) 1px,
          transparent 1px,
          transparent 78px
        ),
        repeating-linear-gradient(25deg,
          rgba(106,167,255,.14) 0px,
          rgba(106,167,255,.14) 1px,
          transparent 1px,
          transparent 92px
        );
      transform: translate3d(0,0,0);
      animation: netDrift 18s linear infinite;
    }
    .net-overlay::after{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(900px 500px at 50% 15%, rgba(255,255,255,.05), transparent 60%);
      opacity:.9;
    }
    @keyframes netDrift{
      from{ transform: translate3d(-18px,-12px,0); }
      to  { transform: translate3d(18px,12px,0); }
    }

    /* Keep content above overlay */
    main{ position: relative; z-index: 1; }

    /* ---------- Header pill ---------- */
    .page-head{ margin-top: 16px; }
    .top-pill{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding:18px 22px;
      border-radius:22px;
      border:1px solid var(--stroke);
      background: var(--glass);
      box-shadow: var(--shadow), var(--inner);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
    }
    .top-pill .title{
      font-size: 26px;
      letter-spacing: .08em;
      text-transform: uppercase;
      opacity: .95;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 60vw;
    }
    .top-pill .sub{
      opacity:.74;
      font-size: 13px;
      text-align:right;
      line-height: 1.4;
      max-width: 42ch;
    }

    /* ---------- Layout (equal-height columns) ---------- */
    .detail-wrap.equal-height{
      display:grid;
      grid-template-columns: 1.1fr 1fr;
      gap:18px;
      margin-top: 18px;
      align-items: stretch;
    }
    @media (max-width: 980px){
      .detail-wrap.equal-height{ grid-template-columns:1fr; }
      .top-pill{ flex-direction:column; align-items:flex-start; }
      .top-pill .sub{ text-align:left; max-width:none; }
      .top-pill .title{ max-width:100%; }
    }

    /* ---------- Make cards more transparent + glassy ---------- */
    /* Your base .card comes from assets/styles.css. We override softly. */
    .card{
      background: rgba(255,255,255,.028) !important;
      border: 1px solid rgba(255,255,255,.10) !important;
      box-shadow: 0 26px 90px rgba(0,0,0,.42), inset 0 1px 0 rgba(255,255,255,.06) !important;
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
    }

    /* Left column */
    .equal-height > .card{
      height: 100%;
      display:flex;
      flex-direction:column;
    }
    .left-stack{
      display:flex;
      flex-direction:column;
      gap:14px;
      flex:1;
      min-height: 0;
    }

    .sub-card{
      padding: 18px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
    }
    .sub-card:hover{
      border-color: rgba(255,255,255,.12);
      background: rgba(255,255,255,.035);
    }

    .label{
      font-size: 12px;
      letter-spacing: .14em;
      text-transform: uppercase;
      opacity: .72;
      margin-bottom: 10px;
    }
    .value{
      font-size: 44px;
      letter-spacing: -0.02em;
      line-height: 1.05;
      margin: 0;
    }

    .muted{ opacity:.72; }
    .desc{
      margin:0;
      line-height: 1.55;
      font-size: 14px;
    }

    /* Actions pinned to bottom */
    .actions-row{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin-top: auto;
      padding-top: 6px;
    }
    @media (max-width: 980px){
      .actions-row{ grid-template-columns: 1fr; }
    }

    .action-tile{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.035);
      text-decoration:none;
      color:inherit;
      cursor:pointer;
      transition: transform .18s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease;
      user-select:none;
      font-weight: 650;
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
    }
    .action-tile:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.055);
      border-color: rgba(255,255,255,.16);
      box-shadow: 0 18px 55px rgba(0,0,0,.32), inset 0 1px 0 rgba(255,255,255,.06);
    }
    .action-tile[aria-disabled="true"]{
      opacity:.45;
      pointer-events:none;
      transform:none;
      box-shadow:none;
    }

    /* Right column */
    .right-head{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      margin-bottom: 10px;
    }
    .section-title{
      margin:0;
      font-size: 12px;
      letter-spacing: .14em;
      text-transform: uppercase;
      opacity:.72;
    }

    .spec-table{ width:100%; border-collapse:collapse; }
    .spec-table tr{ border-top:1px solid rgba(255,255,255,.08); }
    .spec-table td{ padding:14px 12px; vertical-align:top; }
    .spec-table td:first-child{ opacity:.78; }
    .spec-table td:last-child{ text-align:right; font-weight:650; }

    /* Hide footer in this page */
    .footer{ display:none; }

    /* ---------- Modals ---------- */
    .mv-modal{
      position: fixed;
      inset: 0;
      display:none;
      z-index: 9999;
    }
    .mv-modal.is-open{ display:block; }
    .mv-backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .mv-panel{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%);
      width:min(1100px, 92vw);
      height:min(720px, 86vh);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,14,22,.78);
      box-shadow: 0 40px 140px rgba(0,0,0,.65), inset 0 1px 0 rgba(255,255,255,.06);
      overflow:hidden;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
    .mv-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .mv-title{
      font-size: 12px;
      letter-spacing: .14em;
      text-transform: uppercase;
      opacity:.8;
    }
    .mv-close{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color:inherit;
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      transition: background .18s ease, border-color .18s ease, transform .18s ease;
    }
    .mv-close:hover{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.18);
      transform: translateY(-1px);
    }
  </style>
</head>

<body>
  <!-- subtle â€œnetâ€ effect overlay (Apple-like glow + lines) -->
  <div class="net-overlay" aria-hidden="true"></div>

  <main class="container">
    <section class="page-head">
      <div class="top-pill">
        <div class="title" id="h1">Loadingâ€¦</div>
        <div class="sub" id="desc"></div>
      </div>
    </section>

    <section class="detail-wrap equal-height">
      <!-- LEFT COLUMN -->
      <div class="card left-col">
        <div class="left-stack">
          <div class="sub-card">
            <div class="label">Price</div>
            <div class="value" id="priceVal">â€”</div>
          </div>

          <div class="sub-card">
            <div class="label">Stock</div>
            <div class="value" id="stockVal">â€”</div>
          </div>

          <div class="sub-card">
            <p id="longDesc" class="desc muted" style="margin:0;"></p>
          </div>

          <div class="actions-row">
            <a id="videoBtn" class="action-tile" href="#" target="_blank" rel="noreferrer">
              <span>â–¶</span><span>Video</span>
            </a>

            <button id="openCatalogBtn" class="action-tile" type="button" title="Open catalog">
              <span>ðŸ“„</span><span>Catalog</span>
            </button>

            <button id="open3dBtn" class="action-tile" type="button" title="Open 3D model">
              <span>â¬¡</span><span>3D Model</span>
            </button>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="card right-col">
        <div class="right-head">
          <h3 class="section-title">Specifications</h3>
        </div>
        <div id="specWrap"></div>
      </div>
    </section>

    <div class="footer">Internal use only</div>
  </main>

  <script src="assets/app.js"></script>

  <!-- 3D Modal -->
  <div id="viewerModal" class="mv-modal" aria-hidden="true">
    <div class="mv-backdrop" id="close3dBackdrop"></div>
    <div class="mv-panel" role="dialog" aria-modal="true" aria-label="3D Viewer">
      <div class="mv-header">
        <div class="mv-title">3D View</div>
        <button class="mv-close" id="close3dBtn" type="button">âœ•</button>
      </div>
      <div id="mvMount" style="width:100%;height:calc(100% - 54px);background:#0b0f17;"></div>
    </div>
  </div>

  <!-- Catalog Modal -->
  <div id="catalogModal" class="mv-modal" aria-hidden="true">
    <div class="mv-backdrop" id="closeCatalogBackdrop"></div>
    <div class="mv-panel" role="dialog" aria-modal="true" aria-label="Catalog Viewer">
      <div class="mv-header">
        <div class="mv-title" id="catalogTitle">Catalog</div>
        <button class="mv-close" id="closeCatalogBtn" type="button">âœ•</button>
      </div>
      <iframe
        id="catalogFrame"
        title="Catalog PDF"
        src=""
        loading="lazy"
        style="width:100%; height:calc(100% - 54px); border:0; background:#fff;"
        allow="fullscreen">
      </iframe>
    </div>
  </div>

  <script>
    const PRODUCTS_URL = "./products.json";
    const DUKEJIA = "DUKEJIA";

    // Demo fallbacks (lets you test UI even when URLs are missing)
    const DEMO_CATALOG_PDF = "https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf";
    const DEMO_GLB = "https://modelviewer.dev/shared-assets/models/Astronaut.glb";

    function youtubeWatchUrl(youtubeId) {
      if (!youtubeId) return "";
      const [id, rest] = String(youtubeId).split("&");
      return `https://www.youtube.com/watch?v=${id}${rest ? "&" + rest : ""}`;
    }

    // Convert Drive "view" links to "preview" so it opens inside iframe (same tab, modal)
    function toPreview(url) {
      if (!url) return "";
      const s = String(url);
      if (s.includes("/preview")) return s;
      const m = s.match(/drive\.google\.com\/file\/d\/([^/]+)/);
      if (m && m[1]) return `https://drive.google.com/file/d/${m[1]}/preview`;
      return s;
    }

    async function loadProducts() {
      const res = await fetch(PRODUCTS_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to load products.json");
      const data = await res.json();

      // Deduplicate by id
      const seen = new Set();
      const unique = [];
      for (const p of data) {
        const id = String(p.id || "").trim();
        if (!id || seen.has(id)) continue;
        seen.add(id);
        unique.push(p);
      }

      // Force brand DUKEJIA
      return unique.map(p => ({ ...p, brand: DUKEJIA }));
    }

    async function ensureModelViewerScript() {
      if (window.customElements && window.customElements.get("model-viewer")) return;
      await new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.type = "module";
        s.src = "https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js";
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });
    }

    (async () => {
      const id = getParam("id");
      const products = await loadProducts();
      const m = products.find(p => String(p.id) === String(id)) || products[0];
      if (!m) throw new Error("Machine not found");

      document.title = `${m.brand} â€¢ ${m.model} â€¢ Machine`;

      // Top pill text
      $("#h1").textContent = `${m.brand} â€¢ ${m.model}`;
      $("#desc").textContent = m.name || "";

      // Long description
      $("#longDesc").textContent = m.description || "";

      // Price
      const priceInr = (m.priceINR != null) ? moneyINR(Number(m.priceINR)) : "â€”";
      $("#priceVal").textContent = priceInr;

      // Stock
      const qty = (m.stockQty != null) ? Number(m.stockQty) : null;
      $("#stockVal").textContent = (qty == null) ? "â€”" : String(qty);

      // Specs
      const spec = m.spec || {};
      const entries = Object.entries(spec);
      if (!entries.length) {
        $("#specWrap").innerHTML = `<div class="muted" style="padding:10px 2px;">No specifications added.</div>`;
      } else {
        $("#specWrap").innerHTML = `
          <table class="spec-table">
            <tbody>
              ${entries.map(([k,v]) => {
                const val = Array.isArray(v) ? v.join(", ") : String(v);
                return `<tr><td>${safeText(k)}</td><td>${safeText(val)}</td></tr>`;
              }).join("")}
            </tbody>
          </table>
        `;
      }

      // Video button
      const videoUrl = youtubeWatchUrl(m.media && m.media.youtubeId) || m.videoUrl || "";
      const videoBtn = $("#videoBtn");
      if (videoUrl) {
        videoBtn.href = videoUrl;
        videoBtn.removeAttribute("aria-disabled");
      } else {
        videoBtn.setAttribute("aria-disabled","true");
        videoBtn.title = "Video not available";
        videoBtn.removeAttribute("href");
      }

      // Catalog modal (same tab)
      const catalogUrlReal = m.catalogUrl || m.catalogueUrl || m.catalog || "";
      const openCatalogBtn = $("#openCatalogBtn");
      const catalogModal = $("#catalogModal");
      const catalogFrame = $("#catalogFrame");

      openCatalogBtn.addEventListener("click", () => {
        const usingDemo = !catalogUrlReal;
        $("#catalogTitle").textContent =
          usingDemo ? `${m.brand} â€¢ ${m.model} Catalog (Demo)` : `${m.brand} â€¢ ${m.model} Catalog`;

        const finalCatalogUrl = usingDemo ? DEMO_CATALOG_PDF : toPreview(catalogUrlReal);
        catalogFrame.src = finalCatalogUrl;

        catalogModal.classList.add("is-open");
        catalogModal.setAttribute("aria-hidden","false");
      });

      function closeCatalog() {
        catalogModal.classList.remove("is-open");
        catalogModal.setAttribute("aria-hidden","true");
        catalogFrame.src = "";
      }
      $("#closeCatalogBtn").addEventListener("click", closeCatalog);
      $("#closeCatalogBackdrop").addEventListener("click", closeCatalog);

      // 3D modal (same tab)
      const glbUrlReal = m.glbUrl || m.model3dUrl || m.glb || "";
      const open3dBtn = $("#open3dBtn");
      const viewerModal = $("#viewerModal");
      const mvMount = $("#mvMount");

      open3dBtn.addEventListener("click", async () => {
        viewerModal.classList.add("is-open");
        viewerModal.setAttribute("aria-hidden","false");

        const finalGlb = glbUrlReal || DEMO_GLB;

        mvMount.innerHTML = `<div class="muted" style="padding:14px;">Loading 3D viewerâ€¦</div>`;
        await ensureModelViewerScript();

        mvMount.innerHTML = `
          <model-viewer
            src="${safeText(finalGlb)}"
            alt="Machine 3D model"
            camera-controls
            auto-rotate
            shadow-intensity="1"
            exposure="1"
            environment-image="neutral"
            style="width:100%; height:100%; background:#0b0f17;">
          </model-viewer>
        `;
      });

      function close3d() {
        viewerModal.classList.remove("is-open");
        viewerModal.setAttribute("aria-hidden","true");
        mvMount.innerHTML = "";
      }
      $("#close3dBtn").addEventListener("click", close3d);
      $("#close3dBackdrop").addEventListener("click", close3d);

      // ESC closes modals
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          if (viewerModal.classList.contains("is-open")) close3d();
          if (catalogModal.classList.contains("is-open")) closeCatalog();
        }
      });

    })().catch(err => {
      console.error(err);
      $("#h1").textContent = "Machine not found";
      $("#desc").textContent = "Check the URL or products.json.";
      $("#longDesc").textContent = "";
      $("#priceVal").textContent = "â€”";
      $("#stockVal").textContent = "â€”";
      $("#specWrap").innerHTML = `<div class="muted" style="padding:10px 2px;">Failed to load data.</div>`;
    });
  </script>
</body>
</html>
